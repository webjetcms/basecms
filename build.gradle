/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

plugins {
    id 'java-library'
    id 'war'
    id 'org.gretty' version "3.0.3"
    id "com.jfrog.artifactory" version "4.9.8"
    id 'idea'
}

repositories {
    jcenter()
    flatDir {
       dirs 'libs'
   }
    mavenCentral()
}

ext {
    webjetVersion = "8.9-SNAPSHOT";
}

war {
    zip64 = true
    exclude('**/node_modules/**')
    exclude('**/src/**')
    exclude('**/tmp/**')
    exclude('**/*.md')
    exclude('**/*.log')
    exclude('**/.npmrc')
    exclude('**/package-lock.json')
    exclude('**/package.json')
    exclude('**/webpack*.js')
    exclude('**/WEB-INF/imgcache/**')
    exclude('**/scss/**')
}

//CI-CD tasky
task explodeWar(type : Copy){
    def workingDir = "build/explodedWar"
    def zipFile = file("build/libs/${rootProject.name}.war")
    from zipTree(zipFile)
    into workingDir

}
task rsyncExplodedWar(dependsOn : explodeWar,  type: Exec) {
     commandLine "/usr/local/bin/wj-rsync.sh","webjet4.dev.iway.sk","build/explodedWar","/www/tomcat_au27/webapps/${rootProject.name}","tomcat_au27.service","tomcat_au27"
}

//testovanie
task npminstalltest {
    doLast {
        exec {
            workingDir 'src/test/webapp/'
            commandLine 'npm', 'install'
        }
    }
}

task rune2etest {
    doLast {
        exec {
            workingDir 'src/test/webapp/'
            commandLine 'npx', 'codeceptjs', 'run', '--steps'
        }
    }
}

//updatezip - pripravy build/update-DATUM.zip pre aktualizaciu WebJETu v rozbalenej strukture (stary format bez jarpackaging)
task updatezip(type: Exec)  {
    workingDir 'ant/'
    commandLine "ant", "-buildfile", "updatezip.xml", "-Dv8version=${webjetVersion}", "-Dprojectname=${rootProject.name}"
}

dependencies {

    modules {
        module("org.apache.struts:struts-core") { replacedBy("sk.iway:webjet", "mame integrovane") }
        module("org.apache.struts:struts-taglib") { replacedBy("sk.iway:webjet", "mame integrovane") }
    }

    compile("sk.iway:webjet:${webjetVersion}")
    compile("sk.iway:webjet:${webjetVersion}:admin")
    compile("sk.iway:webjet:${webjetVersion}:components")
    compile("sk.iway:webjet:${webjetVersion}:struts")
    compile("sk.iway:webjet:${webjetVersion}:daisydiff")
    compile("sk.iway:webjet:${webjetVersion}:jtidy")
    compile("sk.iway:webjet:${webjetVersion}:swagger-ui")

    providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
    providedCompile "javax.servlet:servlet-api:2.5"
    providedCompile "javax.servlet.jsp:javax.servlet.jsp-api:2.3.3"
    providedCompile 'javax.el:javax.el-api:3.0.0'
    providedCompile 'javax.annotation:jsr250-api:1.0'

    testCompile 'junit:junit:4.13.2'

    // https://mvnrepository.com/artifact/org.seleniumhq.selenium/selenium-java
    testCompile group: 'org.seleniumhq.selenium', name: 'selenium-java', version: '3.141.59'

}

configurations {
    all*.exclude group: 'org.slf4j', module: 'slf4j-over-slf4j'
    all*.exclude group: 'org.slf4j', module: 'slf4j-log4j12'
    all*.exclude group: 'org.slf4j', module: 'jcl104-over-slf4j' //je nahradene novsim jcl-over-slf4j
    all*.exclude group: 'commons-logging', module: 'commons-logging'
    all*.exclude group: 'log4j', module: 'log4j'

    //javax.xml.stream:stax-api:1.0-2 -> stax:stax-api:1.0.1
    all*.exclude group: 'javax.xml.stream', module: 'stax-api'

    grettyRunnerTomcat85 {

    }
    grettyRunnerTomcat9 {

    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

compileJava {
    options.incremental = true
    options.fork = true
    options.failOnError = true
    options.encoding = "windows-1250"
}

artifactory {
    contextUrl = "${artifactory_contextUrl}"
    resolve {
        repository {
            repoKey = 'gradle-dev'
            username = "${artifactory_user}"
            password = "${artifactory_password}"
            maven = true
        }
    }
}

gretty {
    // supported values:
    // 'jetty7', 'jetty8', 'jetty9', 'jetty9.3', 'jetty9.4', 'tomcat7', 'tomcat8'
    servletContainer = 'tomcat9'
    contextPath = ''
    httpPort = 80
    //hard mod spusti WJ rovno z src/main/webapp co zrychli start (netreba kopirovat JSP subory niekde inde)
    inplaceMode = 'hard'
    //scanovania pre hotswap
    scanInterval = 1
    scanner = 'jdk'
    scanDir '${projectDir}/build/classes/java/main'
    fastReload = true
    managedClassReload = true
    //JVM parametre
    jvmArgs = [
        //odporucane premenne pre Tomcat
        '-Dsun.net.client.defaultConnectTimeout=300000',
        '-Dsun.net.client.defaultReadTimeout=300000',
        '-Dfile.encoding=utf-8',
        '-Duser.language=sk',
        '-Duser.country=SK',
        //povolenie remote debug na porte 5005
        '-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005',
        //Uprava konfiguracie pre WebJET, tymto sa prepisuju hodnoty z databazy v Ovladaci panel->Konfiguracia
        '-Dwebjet.smtpServer=localhost'
    ]
}