import org.apache.tools.ant.taskdefs.condition.Os

import com.github.jk1.license.render.*
import com.github.jk1.license.filter.*

/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

plugins {
    id 'java-library'
    id 'war'
    id 'org.gretty' version "3.1.1"
    id "com.jfrog.artifactory" version "4.26.1"
    id 'idea'
    //https://docs.freefair.io/gradle-plugins/current/reference/ + https://projectlombok.org
    id "io.freefair.lombok" version "8.0.1"
    id "org.owasp.dependencycheck" version "8.2.1"
    id 'jacoco'
    //https://github.com/jk1/Gradle-License-Report
    id 'com.github.jk1.dependency-license-report' version '2.5'
}

repositories {
    mavenCentral()
    maven {
        url "https://pd4ml.tech/maven2/"
    }
    flatDir {
       dirs 'libs'
   }
}

ext {
    webjetVersion = "2024.40";
    mapstructVersion = "1.4.2.Final";
    npm = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm";
    npx = Os.isFamily(Os.FAMILY_WINDOWS) ? "npx.cmd" : "npx";
}

war {
    zip64 = true
    exclude('**/node_modules/**')
    exclude('**/node_scripts/**')
    exclude('**/src/**')
    exclude('**/tmp/**')
    exclude('**/*.md')
    exclude('**/*.log')
    exclude('**/*.map')
    exclude('**/.npmrc')
    exclude('**/.editorconfig')
    exclude('**/gulpfile.js')
    exclude('**/package-lock.json')
    exclude('**/package.json')
    exclude('**/webpack*.js')
    exclude('**/WEB-INF/imgcache/**')
    exclude('**/scss/**')
    exclude('**/LICENSE')
    exclude('scratchpad*.jsp')
    exclude('localconf*.jsp')
    //neprikladaj poolman-local.xml
    rootSpec.exclude('**/poolman-*.xml')
    //neprikladaj ukazkove (basecms) subory
    exclude('src/main/java/sk/iway/basecms/**')
    exclude('src/main/webapp/apps/basecms/**')
    exclude('src/main/webapp/apps/contact/**')
}

// build public war
// vybuilduje public war
def defaultExcludes = file('gradle/config/defaultExcludes.txt').text.readLines()
def defaultPublicExcludes = file('gradle/config/defaultPublicExcludes.txt').text.readLines()

task prepareDataForPublicWar() {
    // Ziskame cestu k .war suboru, ktorý budeme rozbalovat
    def warFile = file("${buildDir}/libs/${rootProject.name}.war")

    // Ziskame cestu k adresaru, kde sa bude .war subor rozbalovat
    def publicTempDir = file("${buildDir}/public-temp")

    // Uistime sa, ze tempDir existuje
    delete publicTempDir
    publicTempDir.mkdirs()

    doLast {
        // Rozbalime .war subor do tempDir
        copy {
            from zipTree(warFile)
            into publicTempDir
        }

        // Odstranime .jar subor z tempDir
        delete fileTree("${publicTempDir}/WEB-INF/lib").matching {
            include "webjetcms-${webjetVersion}-admin.jar"
        }

        // Rozbalime components.jar do tempDir/components-all
        def componentsJar = file("${publicTempDir}/WEB-INF/lib/webjetcms-${webjetVersion}-components.jar")
        def componentsAllDir = file("${publicTempDir}/components-all")
        componentsAllDir.mkdirs()
        copy {
            from zipTree(componentsJar)
            into componentsAllDir
        }
        delete componentsJar
    }
}

task zipAllComponentsBackToJar(type: Zip) {
    def publicTempDir = file("${buildDir}/public-temp")
    def componentsJar = file("${publicTempDir}/WEB-INF/lib/webjetcms-${webjetVersion}-components.jar")
    def componentsAllDir = file("${publicTempDir}/components-all")

    from componentsAllDir
    includeEmptyDirs = false
    exclude defaultExcludes
    exclude defaultPublicExcludes
    exclude "**/admin*"
    archiveFileName = componentsJar.name
    archiveExtension = "jar"
    destinationDirectory = componentsJar.parentFile
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    doLast {
        delete componentsAllDir
    }
}

task buildAllArtifacts(type: Zip) {
    dependsOn clean
    dependsOn war
    dependsOn prepareDataForPublicWar
    dependsOn zipAllComponentsBackToJar

    // tieto tasky musia byt spustene v spravnom poradi, pre makeCli tasky na poradi nezalezi
    tasks.findByName('war').mustRunAfter 'clean'
    tasks.findByName('prepareDataForPublicWar').mustRunAfter 'war'
    tasks.findByName('zipAllComponentsBackToJar').mustRunAfter 'prepareDataForPublicWar'

    // Definujeme výstupný súbor
    def outputWar = file("${buildDir}/libs/${rootProject.name}-public.war")
    // Ziskame cestu k adresaru, kde sa bude .war subor rozbalovat
    def publicTempDir = file("${buildDir}/public-temp")

    // Zabalime tempDir do vystupneho war suboru
    from publicTempDir
    includeEmptyDirs = false
    exclude defaultExcludes
    exclude defaultPublicExcludes
    exclude "/apps/**/admin*"
    exclude "/components/**/admin*"
    exclude "**/classes/**/admin/*Controller*"
    exclude "**/classes/**/Admin*Controller*"
    exclude "**/adminsearch*"
    archiveFileName = outputWar.name
    archiveExtension = "war"
    destinationDirectory = outputWar.parentFile
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    doLast {
        delete publicTempDir
    }
}
// end of build public war

//CI-CD tasky
task explodeWar(dependsOn: ['clean', 'war'], type : Copy){
    def workingDir = "build/explodedWar"
    def zipFile = file("build/libs/${rootProject.name}.war")
    from zipTree(zipFile)
    into workingDir

}
task rsyncExplodedWar(dependsOn : explodeWar,  type: Exec) {
     commandLine "/usr/local/bin/wj-rsync.sh","webjet4.dev.iway.sk","build/explodedWar","/www/tomcat_au27/webapps/${rootProject.name}","tomcat_au27.service","tomcat_au27"
}

//testovanie
task npminstalltest(type: Exec) {
    workingDir 'src/test/webapp/'
    commandLine project.ext.npm, 'install'
}

task rune2etest(type: Exec) {
    workingDir 'src/test/webapp/'
    commandLine project.ext.npx, 'codeceptjs', 'run', '--steps'
}

//updatezip - pripravy build/update-DATUM.zip pre aktualizaciu WebJETu v rozbalenej strukture (stary format bez jarpackaging)
task updatezip(type: Exec)  {
    workingDir 'ant/'
    commandLine "ant", "-buildfile", "updatezip.xml", "-Dv8version=${webjetVersion}", "-Dprojectname=${rootProject.name}"
}

//dependency check - https://jeremylong.github.io/DependencyCheck/index.html
dependencyCheck {
    scanConfigurations=["runtimeClasspath"]
    //format vid https://gist.github.com/milo-minderbinder/1e1ed911c5b2264dc659578f1baaef16
    suppressionFiles=[
        file(new File(project.rootDir, 'dependency-check-suppressions.xml')),
        file(new File(project.rootDir, 'dependency-check-suppressions-project.xml'))
    ]
    analyzers {
        assemblyEnabled=false
        nodeEnabled=false
        nodeAudit {
            yarnEnabled=false
            skipDevDependencies=true
            pnpmEnabled=false
        }
    }
}

licenseReport {
    filters = [new LicenseBundleNormalizer(bundlePath: "$projectDir/licensereport-normalization.json")]
    allowedLicensesFile = new File("$projectDir/licensereport-allowed.json")
    renderers = [new InventoryHtmlReportRenderer()]
}

//code coverage report - generate HTML report from jacoco.exec files
task('generateJacocoReport', type: JacocoReport) {

  executionData fileTree(project.rootDir.absolutePath).include("**/build/jacoco/*.exec")

  sourceDirectories.setFrom project.files(project.sourceSets.main.allSource.srcDirs)
  classDirectories.setFrom project.sourceSets.main.output

  def reportDir = project.reporting.file("${rootDir}/build/jacoco/report")
  reports {
    html.outputLocation = reportDir
  }
  doLast {
    System.out.println "Jacoco report for server created: file://${reportDir.toURI().path}index.html"
  }
}

dependencies {
    implementation("com.webjetcms:webjetcms:${webjetVersion}")
    implementation("com.webjetcms:webjetcms:${webjetVersion}:admin")
    implementation("com.webjetcms:webjetcms:${webjetVersion}:components")
    implementation("com.webjetcms:webjetcms:${webjetVersion}:libs")

    providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
    providedCompile "javax.servlet:servlet-api:2.5"
    providedCompile "javax.servlet.jsp:javax.servlet.jsp-api:2.3.3"
    providedCompile 'javax.el:javax.el-api:3.0.0'
    providedCompile 'javax.annotation:jsr250-api:1.0'

    testImplementation 'junit:junit:4.13.2'

    // https://mvnrepository.com/artifact/org.seleniumhq.selenium/selenium-java
    testImplementation group: 'org.seleniumhq.selenium', name: 'selenium-java', version: '3.141.59'

}

configurations {
    all*.exclude group: 'org.slf4j', module: 'slf4j-log4j12'
    all*.exclude group: 'org.slf4j', module: 'jcl104-over-slf4j' //je nahradene novsim jcl-over-slf4j
    all*.exclude group: 'commons-logging', module: 'commons-logging'
    all*.exclude group: 'log4j', module: 'log4j'

    //javax.xml.stream:stax-api:1.0-2 -> stax:stax-api:1.0.1
    all*.exclude group: 'javax.xml.stream', module: 'stax-api'

    grettyRunnerTomcat9 {
        // gretty pouziva staru verziu commons-io, ktora koliduje s nasou
        // https://mvnrepository.com/artifact/commons-io/commons-io
        exclude group: 'commons-io', module: 'commons-io'
    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

compileJava {
    options.incremental = true
    options.fork = true
    options.failOnError = true
    options.encoding = "utf-8"
}

lombok {
    version = "1.18.28"
    //zrusene kvoli zbytocnym problemom s ActiveRecord config['lombok.accessors.chain'] = 'true'
}

//code coverage
jacoco {
    //set latest version
    toolVersion = "+"
}

test {
    useJUnitPlatform()
}

gretty {
   // supported values:
    // 'jetty7', 'jetty8', 'jetty9', 'jetty9.3', 'jetty9.4', 'tomcat7', 'tomcat8'
    servletContainer = 'tomcat9'
    contextPath = ''
    httpPort = 80
    httpsEnabled = true
    httpsPort = 443
    //hard mod spusti WJ rovno z src/main/webapp co zrychli start (netreba kopirovat JSP subory niekde inde)
    inplaceMode = 'hard'
    //scanovania pre hotswap
    scanInterval = 0
    scanner = 'jetty'
    scanDir "${projectDir}/build/classes/java/main"
    fastReload = true
    //chceme aby sa tomcat nereloadol po zmene triedy, v IDE je potrebne kliknut na Hot Code Replace pre aplikovanie zmeny v triede
    reloadOnClassChange = false
    debugSuspend = false
    //JVM parametre
    jvmArgs = [
        //odporucane premenne pre Tomcat
        '-Dsun.net.client.defaultConnectTimeout=300000',
        '-Dsun.net.client.defaultReadTimeout=300000',
        '-Dfile.encoding=utf-8',
        '-Duser.language=sk',
        '-Duser.country=SK',
        //povolenie remote debug na porte 5005
        '-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005',
        //lokalny poolman-local.xml subor
        //'-DwebjetPoolmanPath=/poolman-local.xml',
        //Uprava konfiguracie pre WebJET, tymto sa prepisuju hodnoty z databazy v Ovladaci panel->Konfiguracia
        '-Dwebjet.smtpServer=smtp.interway.sk',
        "-DwebjetDbname=${System.env.webjetDbname}",
        //zoznam docid ktore je mozne priamo otvorit bez prihlasenia pre Launch Chrome debug rezim
        "-Dwebjet.showDocActionAllowedDocids=4,26"
    ]

    //enable jacoco also for appStart and appStartDebug tasks
    afterEvaluate {
        tasks.appStart {
            file("${rootDir}/build/jacoco/appStart.exec").delete()
            jacoco {
                enabled = true
            }
            finalizedBy tasks.generateJacocoReport
        }
        tasks.appStartDebug {
            file("${rootDir}/build/jacoco/appStartDebug.exec").delete()
            jacoco {
                //enabled = true
            }
            //finalizedBy tasks.generateJacocoReport
        }
        tasks.appAfterIntegrationTest {
            finalizedBy tasks.generateJacocoReport
        }
    }
}